<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FNE Time Clock - QR</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
  body { font-family: Arial, sans-serif; background:#f8f9fa; text-align:center; padding:20px; }
  .card { max-width: 430px; margin: 40px auto; border-radius: 14px; }
  label { display:block; margin-bottom:6px; font-weight:bold; text-align:left; }
  input, select, textarea { font-size:16px; padding:8px; width:80%; max-width:300px; margin:0 auto 10px; display:block; }
  button { background:#d22; color:#fff; border:none; margin-top:18px; border-radius:8px; padding:10px 38px; font-size:17px; }
  button:hover { background:#a00; }
  .alert { max-width:360px; margin:18px auto; }
</style>
</head>
<body>

<h2>FNE Time Clock (QR)</h2>

<div id="clock-section" class="card">
  <div class="card-body">
    <div class="alert alert-success" id="greeting">Loading...</div>

    <div class="section">
      <label for="project">Project</label>
      <input type="text" id="project" placeholder="Project name">
    </div>

    <div class="section">
      <label for="note">Note</label>
      <textarea id="note" placeholder="Optional note"></textarea>
    </div>

    <input type="hidden" id="workerId">

    <button onclick="clockIn()">Clock In</button>
    <div id="status" style="margin-top:12px;"></div>
  </div>
</div>

<script>
function pad(n){return n<10?'0'+n:n;}
function getDateTime(){
  const now = new Date();
  const date = now.getFullYear()+'-'+pad(now.getMonth()+1)+'-'+pad(now.getDate());
  const time = pad(now.getHours())+':'+pad(now.getMinutes());
  return { date, time };
}

document.addEventListener('DOMContentLoaded', function(){
  const params = new URLSearchParams(window.location.search);
  const worker_id = params.get('worker_id');
  if(!worker_id){ alert('Worker ID missing'); return; }

  fetch(`/api/qr/worker-info?worker_id=${worker_id}`)
    .then(r=>r.json())
    .then(worker=>{
      document.getElementById('greeting').textContent = `Hello, ${worker.name}`;
      document.getElementById('workerId').value = worker.worker_id;
    })
    .catch(()=> alert('Worker not found'));
});

function clockIn(){
  const worker_id = document.getElementById('workerId').value;
  const project = document.getElementById('project').value;
  const note = document.getElementById('note').value;
  if(!worker_id){ alert('Worker missing'); return; }
  if(!project){ alert('Enter project'); return; }

  const dt = getDateTime();

  fetch('/api/clock/clockin', {
    method:'POST',
    headers:{ 'Content-Type':'application/json' },
    body: JSON.stringify({ worker_id, project, note, date: dt.date, time: dt.time })
  })
  .then(r=>r.json())
  .then(res=>{
    if(res.success) document.getElementById('status').textContent = 'Clock-in recorded!';
    else document.getElementById('status').textContent = 'Failed to clock in';
  })
  .catch(()=> document.getElementById('status').textContent='Error connecting to server');
}
</script>

</body>
</html>
