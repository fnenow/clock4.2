<!DOCTYPE html>
<html>
<head>
  <title>FNE Time Clock - Payroll Grouped</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .payroll-group-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      background: #fff;
    }
    .payroll-group-table th, .payroll-group-table td {
      border: 1px solid #bdbdbd;
      padding: 6px 10px;
      text-align: center;
      vertical-align: middle;
    }
    .payroll-group-table th {
      background: #bdbdbd;
      color: #222;
      font-weight: bold;
    }
    .payroll-date-cell {
      font-weight: bold;
      background: #eee;
      min-width: 110px;
    }
    .payroll-group-table tr:nth-child(even) td:not(.payroll-date-cell) {
      background: #f6f6f6;
    }
  </style>
</head>
<body class="bg-light">
<div class="container mt-5">
  <h2 class="text-center mb-3">Payroll (Grouped by Date)</h2>
  <!-- Optional: Filters can be added here if needed, similar to payroll.html -->
  <div id="payroll-table-grouped"></div>
</div>

<script>
// Utility to format date (copied from payroll.js)
function formatDateDisplay(str) {
  if (!str) return '';
  const d = new Date(str);
  if (!isNaN(d.getTime())) {
    return d.toISOString().slice(0, 10);
  }
  return str.length > 10 ? str.slice(0, 10) : str;
}

// Render grouped payroll table
function renderPayrollGroupedTable(data) {
  let html = `<table class="payroll-group-table">
    <thead>
      <tr>
        <th>Date</th>
        <th>Project</th>
        <th>Worker</th>
        <th>In</th>
        <th>Out</th>
        <th>Hours</th>
        <th>OT</th>
        <th>Rate</th>
        <th>Amount</th>
      </tr>
    </thead>
    <tbody>`;

  let currentGroupDate = "";
  data.forEach(entry => {
    html += "<tr>";
    if (entry.date !== currentGroupDate) {
      currentGroupDate = entry.date;
      html += `<td class="payroll-date-cell">${entry.date}</td>`;
    } else {
      html += `<td class="payroll-date-cell"></td>`;
    }
    html += `
      <td>${entry.project}</td>
      <td>${entry.worker}</td>
      <td>${entry.in}</td>
      <td>${entry.out}</td>
      <td>${entry.hours}</td>
      <td>${entry.ot}</td>
      <td>${entry.rate}</td>
      <td>${entry.amount}</td>
    </tr>`;
  });

  html += "</tbody></table>";
  document.getElementById("payroll-table-grouped").innerHTML = html;
}

// Load real payroll data from backend and render
async function loadPayrollGrouped() {
  // You can add filters here if needed, similar to payroll.html
  const res = await fetch('/api/payroll');
  const { rows } = await res.json();

  // Compose and group rows for display like the screenshot
  // First, sort by date
  rows.sort((a, b) => {
    const aDate = a.datetime_local || a.datetime_utc || '';
    const bDate = b.datetime_local || b.datetime_utc || '';
    return aDate.localeCompare(bDate);
  });

  // Project to the format needed for grouped table
  const groupedRows = [];
  let lastDate = '';
  for (const row of rows) {
    // Use only regular+OT as separate rows, or sum if you want to combine (here we just show all)
    // "Date" as local date (YYYY-MM-DD)
    const date = formatDateDisplay(row.datetime_local || row.datetime_utc);
    groupedRows.push({
      date,
      project: row.project_name || '',
      worker: row.worker_name || '',
      in: row.datetime_local ? row.datetime_local.slice(11, 16) : '', // "HH:MM"
      out: row.datetime_out_local ? row.datetime_out_local.slice(11, 16) : '',
      hours: row.regular_time && Number(row.regular_time) !== 0
        ? Number(row.regular_time)
        : (row.overtime && Number(row.overtime) !== 0 ? Number(row.overtime) : ''),
      ot: row.overtime && Number(row.overtime) !== 0 ? Number(row.overtime) : '',
      rate: row.pay_rate ? Number(row.pay_rate) : '',
      amount: row.pay_amount ? Number(row.pay_amount) : ''
    });
  }

  // Group by date for visual effect (first row of each date shows the date, others are blank)
  let renderArr = [];
  let currentDate = '';
  for (let row of groupedRows) {
    if (row.date !== currentDate) {
      currentDate = row.date;
      renderArr.push({ ...row });
    } else {
      renderArr.push({ ...row, date: '' });
    }
  }

  renderPayrollGroupedTable(renderArr);
}

window.onload = loadPayrollGrouped;
</script>
</body>
</html>
